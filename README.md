# Telegram-бот для поздравлений менторов Devman

## Описание

Этот бот помогает автоматически поздравлять менторов с праздниками, предоставляя удобный интерфейс для выбора ментора и отправки персонализированной открытки. Сделайте поздравления более удобными и эффективными!

## Структура проекта
### Основные файлы и директории:
- `main.py:` Главный файл для запуска Telegram-бота. Настраивает обработчики команд и сообщений.
- `libs/api_client/api_requests.py:` Модуль, содержащий Pydantic-модели для менторов и открыток. Функции response_postcards и response_mentors извлекают и валидируют данные о менторах и открытках, проверяя их формат на соответствие ожидаемым моделям. Декоратор handle_error_response обрабатывает ошибки запросов API.
- `handlers/handlers.py:` Обработчики событий Telegram-бота, включая команды и сообщения.
- `utils/format_long_name.py:` Утилита для форматирования длинных имен менторов.
- `utils/start_role.py:` Определяет роль пользователя (ментор или ученик) на основе его Telegram ID.
- `utils/insert_name.py:` Вставляет имя в открыту поздравления.
- `utils/long_message.py:` Обрезает сообщения, которые более 4096 длинной.
- `tests/:` Модули api_mentors, api_postcards и .json файлы для запуска локального тестового FastAPI сервера.

## Установка
1. Клонируйте репозиторий:

    ```python
    git clone <URL репозитория>
    cd <имя директории>
    ```
2. Установите зависимости:
    ```python
    pip install -r requeriments.txt
    ```
3. Создайте файл .env в корне проекта и добавьте ваш Telegram токен:
    ```text
    TG_TOKEN=ваш_токен_бота
    ```

## Запуск
Для запуска Telegram-бота выполните:
    ```
    python main.py
    ```

## Функциональность бота
1. `Команда /start:`

    - Приветствует пользователя и определяет его роль (ментор или ученик).

    - Показывает клавиатуру с кнопками:
        - "Показать менторов"
        - "Показать открытки"

2. `Кнопки:`

    - "Показать менторов": Отображает список менторов с их именами и ссылками на Telegram.
    - "Показать открытки": Показывает список доступных открыток.

3. `Выбор ментора и отправка открытки:`

    - Пользователь выбирает ментора из списка.
    - Затем выбирает открытку, которая будет отправлена выбранному ментору.

4. `Обработка ошибок:`

    - Обрабатываются ошибки Telegram API (например, пользователь заблокировал бота).
    - Предоставляются сообщения об ошибках при некорректных действиях.



## Локальный сервер API для тестирования

Для тестирования бота с вашими собственными данными и схемами, вы можете развернуть локальный сервер API.

### Шаги по развертыванию локального сервера и его запуск:
1. Установите FastAPI и Uvicorn:

    ```bash
    pip install fastapi uvicorn
    ```

### Сервер Менторов

1. Перейдите в директорию с файлом `tests/api_mentors.py`.
2. Запустите сервер с помощью Uvicorn:
        ```
        uvicorn api_mentors:app --host 127.0.0.1 --port 8002 --reload
        ```
*   `api_mentors:app` - указывает на файл `api_mentors.py` и экземпляр FastAPI приложения `app`.
*   `--host 127.0.0.1` - задает хост для сервера (localhost).
*   `--port 8002` - задает порт для сервера.
*   `--reload` - включает автоматическую перезагрузку сервера при изменении кода.

3. После запуска сервер будет доступен по адресу: `http://127.0.0.1:8002`

### Сервер Открыток

1. Перейдите в директорию с файлом `tests/api_postcards.py`.
2. Запустите сервер с помощью Uvicorn:
        ```
        uvicorn api_postcards:app --host 127.0.0.1 --port 8005 --reload
        ```

3. После запуска сервер будет доступен по адресу: `http://127.0.0.1:8005`

## Доступные эндпоинты

### Сервер Менторов (http://127.0.0.1:8002)

*   `/api/v1/empty_list` - Возвращает пустой список менторов.
*   `/api/v1/thirty_mentors` - Возвращает список из 30 менторов.
*   `/api/v1/three_mentors` - Возвращает список из 3 менторов.
*   `/api/v1/long_name` - Возвращает ментора с очень длинным именем.
*   `/api/v1/invalid` - Возвращает JSON с ошибкой в синтаксисе.
*   `/api/v1/not_match_schema` - Возвращает данные, не соответствующие схеме (например, неправильные типы данных).
*   `/api/v1/return_more_data` - Возвращает дополнительные данные, не предусмотренные схемой.
*   `/api/v1/i_mentor` - Возвращает информацию об одном менторе (нужно указать ваши данные).
#### Пример ответа для `/api/v1/three_mentors`:
```bash
    [
    {"id":1,"name":{"first":"Евгений","second":"Devman"},"tg_username":"@dev","tg_chat_id":2321,"bday":"1991-02-23"},
    {"id":2,"name":{"first":"Ильмир","second":"Devman"},"tg_username":"@i_d","tg_chat_id":32},
    {"id":3,"name":{"first":"Нурбек","second":"Devman"},"tg_username":"@n_dev","tg_chat_id":123,"bday":"1991-02-23"}
    ]
```
### Сервер Открыток (http://127.0.0.1:8005)

*   `/api/v1/postcards_len_500` - Возвращает открытку с текстом длиннее 500 символов.
*   `/api/v1/postcards_name_template` - Возвращает открытку с шаблоном для имени.
*   `/api/v1/postcards_empty_list` - Возвращает пустой список открыток.
*   `/api/v1/postcards_130` - Возвращает список из 130 открыток.
*   `/api/v1/postcards_5` - Возвращает список из 5 открыток.
*   `/api/v1/postcards_invalid` - Возвращает JSON с ошибкой в синтаксисе.
*   `/api/v1/postcards_not_holidaisid` - Возвращает данные, не соответствующие схеме (например, отсутствует `holidayId`).
*   `/api/v1/postcards_return_more_data` - Возвращает дополнительные данные, не предусмотренные схемой.
#### Пример ответа для `/api/v1/postcards_5`:
```bash
    [
    {"id": 1, "holidayId": "01.01", "name_ru": "Новый год", "body": "С Новым годом! Пусть этот год принесёт тебе радость, процветание и успех!"},
    {"id": 2, "holidayId": "01.07", "name_ru": "Рождество Христово (Православие)", "body": "С Рождеством Христовым! Христос рождается!"},
    {"id": 3, "holidayId": "birthday", "name_ru": "День рождения", "body": "#name, С Днём рождения! Желаю счастья, мира и благополучия!"},
    {"id": 4, "holidayId": "08.03", "name_ru": "Международный женский день", "body": "С 8 Марта! Желаю весны в душе и ярких впечатлений!"},
    {"id": 5, "holidayId": "23.02", "name_ru": "День защитника Отечества", "body": "С 23 Февраля! Желаю мужества, силы и удачи!"}
    ]
```
## Примеры запросов

Вы можете использовать любой другой инструмент для отправки HTTP-запросов для тестирования API.

### Пример запроса к серверу менторов:
```bash
http://127.0.0.1:8002/api/v1/three_mentors
```


### Пример запроса к серверу открыток:
```bash
http://127.0.0.1:8005/api/v1/postcards_5
```

## Обработка ошибок

Приложение обрабатывает различные типы ошибок для обеспечения стабильности и информативности. Ниже приведены основные типы ошибок и их описание:

1.  **Сетевые ошибки (`NetworkError`)**

    Эти ошибки возникают при проблемах с сетевым соединением, например, если сервер недоступен или нет соединения с Интернетом.

2.  **Ошибки формата ответа (`ResponseFormatError`)**

    Эти ошибки возникают, когда ответ от сервера имеет неожиданный формат, что может привести к проблемам с парсингом данных.

3.  **Ошибки сервера (`ServerError`)**

    Эти ошибки включают в себя различные проблемы на стороне сервера, такие как невалидный JSON, неправильные HTTP-запросы или ошибки аутентификации.

4.  **Общие ошибки**

    Любые другие необработанные исключения также обрабатываются и регистрируются для дальнейшего анализа.

### Примеры ошибок:

- `JSONDecodeError`: Возникает при невалидном JSON в ответе от сервера.
- `httpx.RequestError`: Обработка ошибок запросов, включая соединения и таймауты.
- `httpx.HTTPStatusError`: Обработка HTTP-статусов, отличных от 2xx, таких как 404 или 500.


## Лицензия
MIT